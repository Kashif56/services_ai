{% extends 'base.html' %}
{% load static %}

{% block title %}Test AI Agent - {{ business.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                    <h6>Test AI Agent</h6>
                    <a href="{% url 'ai_agent:dashboard' %}" class="btn btn-sm btn-primary">Back to Dashboard</a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Chat with {{ business.name }} AI Assistant</h5>
                                </div>
                                <div class="card-body">
                                    <div id="chat-messages" class="chat-container mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 15px; border-radius: 5px;">
                                        <div class="system-message">
                                            <p>Welcome to the AI Assistant test interface. Type a message to start chatting with your AI agent.</p>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <input type="text" id="message-input" class="form-control" placeholder="Type your message here...">
                                        <button id="send-button" class="btn btn-primary">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Test Information</h5>
                                </div>
                                <div class="card-body">
                                    <p>This is a test interface for your AI agent. You can use it to:</p>
                                    <ul>
                                        <li>Test your agent's responses</li>
                                        <li>Verify tool functionality</li>
                                        <li>Check prompt effectiveness</li>
                                    </ul>
                                    <p>Try asking about:</p>
                                    <ul>
                                        <li>Booking an appointment</li>
                                        <li>Checking availability</li>
                                        <li>Calculating service costs</li>
                                        <li>Checking payment status</li>
                                    </ul>
                                    <div class="alert alert-info mt-3">
                                        <strong>Note:</strong> This test interface uses a session key to identify you. In a real deployment, clients would be identified by their phone number or session ID.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        // Generate a unique session key for this test session
        const sessionKey = 'test_' + Math.random().toString(36).substring(2, 15);
        
        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'assistant-message';
            messageDiv.style.marginBottom = '10px';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.maxWidth = '80%';
            messageDiv.style.wordWrap = 'break-word';
            
            if (isUser) {
                messageDiv.style.marginLeft = 'auto';
                messageDiv.style.backgroundColor = '#007bff';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.marginRight = 'auto';
                messageDiv.style.backgroundColor = '#f8f9fa';
                messageDiv.style.border = '1px solid #ddd';
            }
            
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, true);
            
            // Clear input
            messageInput.value = '';
            
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'assistant-message loading';
            loadingDiv.style.marginRight = 'auto';
            loadingDiv.style.marginBottom = '10px';
            loadingDiv.style.padding = '10px';
            loadingDiv.style.borderRadius = '5px';
            loadingDiv.style.backgroundColor = '#f8f9fa';
            loadingDiv.style.border = '1px solid #ddd';
            loadingDiv.textContent = 'Thinking...';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Send message to API
            fetch('{% url "ai_agent:process_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    business_id: {{ business.id }},
                    message: message,
                    session_key: sessionKey
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading indicator
                chatMessages.removeChild(loadingDiv);
                
                if (data.success) {
                    // Add assistant response to chat
                    addMessage(data.response, false);
                } else {
                    // Show error
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'system-message error';
                    errorDiv.style.marginBottom = '10px';
                    errorDiv.style.padding = '10px';
                    errorDiv.style.borderRadius = '5px';
                    errorDiv.style.backgroundColor = '#f8d7da';
                    errorDiv.style.color = '#721c24';
                    errorDiv.style.border = '1px solid #f5c6cb';
                    errorDiv.textContent = 'Error: ' + (data.error || 'Unknown error occurred');
                    chatMessages.appendChild(errorDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            })
            .catch(error => {
                // Remove loading indicator
                chatMessages.removeChild(loadingDiv);
                
                // Show error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'system-message error';
                errorDiv.style.marginBottom = '10px';
                errorDiv.style.padding = '10px';
                errorDiv.style.borderRadius = '5px';
                errorDiv.style.backgroundColor = '#f8d7da';
                errorDiv.style.color = '#721c24';
                errorDiv.style.border = '1px solid #f5c6cb';
                errorDiv.textContent = 'Network error: Could not connect to the server';
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.error('Error:', error);
            });
        }
        
        // Send message on button click
        sendButton.addEventListener('click', sendMessage);
        
        // Send message on Enter key
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Focus input on page load
        messageInput.focus();
    });
</script>
{% endblock %}
