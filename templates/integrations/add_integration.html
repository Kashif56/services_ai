{% extends 'common/dashboard_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{% if integration %}Edit{% else %}Add New{% endif %} Integration</h1>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-plug me-1"></i>
            Integration Details
        </div>
        <div class="card-body">
            <form method="POST" action="{% url 'integration:add_integration' %}">
                {% csrf_token %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Service Name</label>
                        <input type="text" name="serviceName" class="form-control" value="{{ integration.name|default:'' }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Platform Type</label>
                        <select name="platformType" class="form-select" id="platformType" required>
                            {% for value, label in platform_types.items %}
                            <option value="{{ value }}" {% if integration.platform_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Direct API fields -->
                <div id="directApiFields" class="platform-fields">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Base URL</label>
                            <input type="url" name="api_url" class="form-control" value="{{ integration.base_url|default:'' }}">
                            <div class="form-text">The base URL for the API endpoint (e.g., https://api.example.com/v1)</div>
                        </div>
                    </div>
                    
                    <!-- Custom Headers Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Custom HTTP Headers</h5>
                                <button type="button" class="btn btn-sm btn-primary" id="addHeaderBtn">
                                    <i class="fas fa-plus me-1"></i>Add Header
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="headersContainer">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Add custom HTTP headers that will be sent with each API request (e.g., X-API-Key, Authorization)
                            </div>
                            
                            {% if headers %}
                                {% for key, value in headers.items %}
                                <div class="row mb-2 header-row">
                                    <div class="col-md-5">
                                        <input type="text" name="header_key" class="form-control" placeholder="Header Name" value="{{ key }}">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" name="header_value" class="form-control" placeholder="Header Value" value="{{ value }}">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger remove-header-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Note about Content-Type Header -->
                                <div class="alert alert-secondary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> The <code>Content-Type: application/json</code> header is automatically added to all API requests.
                                </div>
                                
                                <!-- Common Authorization Header -->
                                <div class="row mb-2 header-row">
                                    <div class="col-md-5">
                                        <input type="text" name="header_key" class="form-control" value="Authorization">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" name="header_value" class="form-control" placeholder="Bearer YOUR_TOKEN_HERE">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger remove-header-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Common API Key Header -->
                                <div class="row mb-2 header-row">
                                    <div class="col-md-5">
                                        <input type="text" name="header_key" class="form-control" value="X-API-Key">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" name="header_value" class="form-control" placeholder="YOUR_API_KEY_HERE">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger remove-header-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Common Accept Header -->
                                <div class="row mb-2 header-row">
                                    <div class="col-md-5">
                                        <input type="text" name="header_key" class="form-control" value="Accept">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" name="header_value" class="form-control" value="application/json">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger remove-header-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Workflow platform fields -->
                <div id="workflowFields" class="platform-fields">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" name="webhook_url" class="form-control" value="{{ integration.webhook_url|default:'' }}">
                            <div class="form-text">The URL where lead data will be sent</div>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input type="checkbox" name="is_active" class="form-check-input" id="isActive" {% if integration.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="isActive">Active</label>
                </div>

                <div class="border-top pt-3">
                    <button type="submit" class="btn btn-primary">Save Integration</button>
                    <a href="{% url 'integration:integration_list' %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const platformType = document.getElementById('platformType');
    const directApiFields = document.getElementById('directApiFields');
    const workflowFields = document.getElementById('workflowFields');
    const addHeaderBtn = document.getElementById('addHeaderBtn');
    const headersContainer = document.getElementById('headersContainer');

    function updateFields() {
        // Hide all fields first
        document.querySelectorAll('.platform-fields').forEach(field => {
            field.style.display = 'none';
        });

        // Show relevant fields based on selected platform type
        const selectedType = platformType.value;
        if (selectedType === 'direct_api') {
            directApiFields.style.display = 'block';
            // Make direct API fields required when this option is selected
            document.querySelector('input[name="api_url"]').required = true;
            // Make webhook URL not required
            document.querySelector('input[name="webhook_url"]').required = false;
        } else {
            workflowFields.style.display = 'block';
            // Make webhook URL required when this option is selected
            document.querySelector('input[name="webhook_url"]').required = true;
            // Make direct API fields not required
            document.querySelector('input[name="api_url"]').required = false;
        }
    }

    // Function to add a new header row
    function addHeaderRow() {
        const headerRow = document.createElement('div');
        headerRow.className = 'row mb-2 header-row';
        headerRow.innerHTML = `
            <div class="col-md-5">
                <input type="text" name="header_key" class="form-control" placeholder="Header Name">
            </div>
            <div class="col-md-5">
                <input type="text" name="header_value" class="form-control" placeholder="Header Value">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-header-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;

        // Add event listener to the remove button
        const removeBtn = headerRow.querySelector('.remove-header-btn');
        removeBtn.addEventListener('click', function() {
            headerRow.remove();
        });

        // Append the new row to the container
        headersContainer.appendChild(headerRow);
    }

    // Add event listener to the Add Header button
    if (addHeaderBtn) {
        addHeaderBtn.addEventListener('click', addHeaderRow);
    }

    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-header-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.header-row').remove();
        });
    });

    platformType.addEventListener('change', updateFields);
    updateFields(); // Initial state
});
</script>
{% endblock %}
{% endblock %}
